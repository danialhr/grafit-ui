name: Upstream Check

on:
  schedule:
    # Run every Monday at 10:00 UTC
    - cron: '0 10 * * 1'
  workflow_dispatch:

jobs:
  check-upstream:
    name: Check shadcn-ui/ui for Updates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch upstream commits
        id: fetch-upstream
        run: |
          git remote add upstream https://github.com/shadcn-ui/ui.git 2>/dev/null || true
          git fetch upstream main
          
          # Get latest upstream commit
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "Latest upstream commit: $UPSTREAM_COMMIT"
          
          # Get tracked commit from registry
          TRACKED_COMMIT=$(grep "trackedCommit:" COMPONENT_REGISTRY.yaml | awk '{print $2}' | tr -d '\r')
          echo "Tracked commit: $TRACKED_COMMIT"
          
          # Check if there are changes
          if [ "$UPSTREAM_COMMIT" != "$TRACKED_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes"
          fi
      
      - name: Check for new components
        id: check-components
        run: |
          # Count components in upstream
          UPSTREAM_COUNT=$(ls -1 upstream/shadcn-ui/apps/v4/registry/new-york-v4/ui/*.tsx 2>/dev/null | wc -l | tr -d ' ')
          echo "Upstream components: $UPSTREAM_COUNT"
          
          # Count implemented components
          IMPLEMENTED_COUNT=$(grep -c "^  [a-z-]*:" COMPONENT_REGISTRY.yaml || echo "0")
          echo "Implemented components: $IMPLEMENTED_COUNT"
          
          # Create summary
          echo "## Upstream Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest upstream commit:** \`${{steps.fetch-upstream.outputs.upstream_commit}}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Components in shadcn-ui/ui:** $UPSTREAM_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Components implemented:** $IMPLEMENTED_COUNT" >> $GITHUB_STEP_SUMMARY
      
      - name: Detect changed files
        if: steps.fetch-upstream.outputs.has_changes == 'true'
        run: |
          git log --oneline HEAD..${{steps.fetch-upstream.outputs.upstream_commit}} -- upstream/shadcn-ui/apps/v4/registry/new-york-v4/ui/ > changed_files.txt
          
          echo "## Changed Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat changed_files.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Create issue if changes detected
        if: steps.fetch-upstream.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: { repository } } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const upstreamCommit = '${{steps.fetch-upstream.outputs.upstream_commit}}';
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ shadcn-ui/ui has updates',
              body: `## Upstream Changes Detected
              
              The shadcn-ui/ui repository has new commits since our last sync.
              
              ### Details
              - **Latest commit:** \`${upstream_commit}\`
              - **View changes:** https://github.com/shadcn-ui/ui/commit/${upstream_commit}
              
              ### Next Steps
              1. Review the changes in shadcn-ui/ui
              2. Update COMPONENT_REGISTRY.yaml with new commit
              3. Implement new components or features
              4. Update affected components
              
              ### Automated
              This issue was created by the Upstream Check workflow.
              `,
              labels: ['upstream', 'dependencies'],
            });
            
            console.log('Created issue #' + issue.data.number);
